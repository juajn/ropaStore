{% extends "base.html" %}
{% block title %}Gestión de Productos - RopaStore{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- ENCABEZADO -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-dark mb-3 mb-md-0">
      <i class="bi bi-box-seam text-primary"></i> Gestión de Productos
    </h2>

    <div class="d-flex gap-2">
      <button class="btn btn-outline-dark rounded-pill shadow-sm" data-bs-toggle="modal" data-bs-target="#modalCategorias">
        <i class="bi bi-tags"></i> Categorías
      </button>
      <a href="{{ url_for('admin.nuevo_producto') }}" class="btn btn-primary rounded-pill shadow-sm">
        <i class="bi bi-plus-circle"></i> Nuevo Producto
      </a>
    </div>
  </div>

  <!-- 🔍 BARRA DE BÚSQUEDA -->
  <div class="input-group mb-4 shadow-sm" style="max-width: 400px;">
    <span class="input-group-text bg-dark text-white"><i class="bi bi-search"></i></span>
    <input type="text" id="searchInput" class="form-control" placeholder="Buscar producto...">
  </div>

  <!-- TABLA DE PRODUCTOS -->
  <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
    <div class="card-header text-black fw-semibold">
      <div class="d-flex justify-content-between align-items-center">
        <span><i class="bi bi-list-ul"></i> Lista de Productos</span>
        <span class="badge bg-light text-dark px-3 py-2">{{ productos|length }} registrados</span>
      </div>
    </div>

    <div class="card-body p-0">
      <div class="table-responsive" style="max-height: 520px; overflow-y: auto;">
        <table class="table table-hover align-middle mb-0 text-center" id="productTable">
          <thead class="table-light sticky-top shadow-sm">
            <tr class="text-uppercase small text-secondary">
              <th>ID</th>
              <th>Nombre</th>
              <th>Precio</th>
              <th>Stock</th>
              <th>Categoría</th>
              <th>Destacado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for p in productos %}
            <tr>
              <td class="text-muted">#{{ p.id }}</td>
              <td class="fw-semibold text-dark">{{ p.nombre }}</td>
              <td>${{ "%.2f"|format(p.precio) }}</td>
              <td>{{ p.stock }}</td>
              <td>{{ p.categoria.nombre if p.categoria else '-' }}</td>
              <td>
                {% if p.destacado %}
                  <span class="badge bg-success">Sí</span>
                {% else %}
                  <span class="badge bg-secondary">No</span>
                {% endif %}
              </td>
              <td>
                <div class="btn-group btn-group-sm" role="group">
                  <a href="{{ url_for('admin.editar_producto', id=p.id) }}" 
                     class="btn btn-outline-warning rounded-circle" data-bs-toggle="tooltip" title="Editar">
                    <i class="bi bi-pencil"></i>
                  </a>
                  <form method="POST" action="{{ url_for('admin.eliminar_producto', id=p.id) }}" class="d-inline"
                        onsubmit="return confirm('¿Seguro que deseas eliminar este producto?');">
                    <button type="submit" class="btn btn-outline-danger rounded-circle" data-bs-toggle="tooltip" title="Eliminar">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="7" class="text-muted py-5">
                <i class="bi bi-box-seam fs-3"></i>
                <p class="mt-2 mb-0">No hay productos registrados.</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>


<!-- ============================= -->
<!-- MODAL DE CATEGORÍAS -->
<!-- ============================= -->
<div class="modal fade" id="modalCategorias" tabindex="-1" aria-labelledby="modalCategoriasLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title"><i class="bi bi-tags"></i> Gestión de Categorías</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formCategoria" method="POST" action="{{ url_for('admin.nueva_categoria') }}" class="d-flex mb-3">
          <input type="text" name="nombre" class="form-control me-2" placeholder="Nueva categoría..." required>
          <button type="submit" class="btn btn-primary"><i class="bi bi-plus-lg"></i></button>
        </form>

        <table class="table table-striped align-middle text-center">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Descripción</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for c in categorias %}
            <tr>
              <td>{{ c.id }}</td>
              <td>{{ c.nombre }}</td>
              <td>{{ c.descripcion or '-' }}</td>
              <td>
                <form method="POST" action="{{ url_for('admin.eliminar_categoria', id=c.id) }}" class="d-inline"
                      onsubmit="return confirm('¿Eliminar esta categoría?');">
                  <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                </form>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="4" class="text-muted py-3">No hay categorías registradas.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ============================= -->
<!-- ESTILOS -->
<!-- ============================= -->
<style>
.table-hover tbody tr:hover {
  background-color: #f8f9fa !important;
  transform: scale(1.005);
  transition: all 0.2s ease;
}
</style>

<!-- ============================= -->
<!-- SCRIPT: BÚSQUEDA DE PRODUCTOS -->
<!-- ============================= -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('searchInput');
  const rows = document.querySelectorAll('#productTable tbody tr');

  input.addEventListener('keyup', () => {
    const filter = input.value.toLowerCase();
    rows.forEach(row => {
      const nombre = row.cells[1]?.textContent.toLowerCase() || '';
      if (nombre.includes(filter)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  });

  // Activar tooltips de Bootstrap
  const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
  tooltips.forEach(t => new bootstrap.Tooltip(t));
});
</script>
{% endblock %}
